// Copyright 2025 Logan Magee
//
// SPDX-License-Identifier: AGPL-3.0-only

syntax = "proto3";

package accrescent.server.events.v1;

import "accrescent/server/events/v1/object_metadata.proto";
import "android/bundle/commands.proto";
import "buf/validate/validate.proto";

option java_multiple_files = true;
option java_package = "app.accrescent.server.events.v1";

// Metadata for a specific version of an Android package.
message PackageMetadata {
  // The version code of the app's latest version.
  optional uint32 version_code = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint32.gt = 0
  ];

  // The display name of the app's latest version, e.g., "1.4.2".
  optional string version_name = 2 [(buf.validate.field).required = true];

  // The resulting metadata of building the app's APK set.
  android.bundle.BuildApksResult build_apks_result = 3 [(buf.validate.field).required = true];

  // A map between each APK path and its corresponding metadata such as
  // uncompressed size.
  map<string, ObjectMetadata> apk_object_metadata = 4;

  option (buf.validate.message).cel = {
    id: "build_apks_result.apks_have_object_metadata_specified"
    message: "all APKs must have object metadata specified"
    expression:
      "this.build_apks_result.variant.all("
      "  v,"
      "  v.apk_set.all("
      "    s,"
      "    s.apk_description.all("
      "      d,"
      "      d.path in this.apk_object_metadata.map(k, k)"
      "    )"
      "  )"
      ")"
  };

  option (buf.validate.message).cel = {
    id: "apk_object_metadata.must_reference_existing_apk"
    message: "APK object metadata must reference existing APK"
    expression:
      "this.apk_object_metadata.map(k, k).all("
      "  id,"
      "  this.build_apks_result.variant.exists("
      "    v,"
      "    v.apk_set.exists("
      "      s,"
      "      id in s.apk_description.map(d, d.path)"
      "    )"
      "  )"
      ")"
  };
}
